{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h2 class="mb-4">Chat with {{ recipient.username }}</h2>

        <!-- 
          --- HTMX POLLING ADDED HERE ---
          hx-get: The URL to fetch for new content.
          hx-trigger: "load" (gets messages on page load)
                      "every 3s" (refreshes every 3 seconds)
          hx-swap: "innerHTML" replaces the content *inside* this div.
        -->
        <div id="chat-window"
             class="chat-container" 
             hx-get="{{ url_for('main.chat_messages', username=recipient.username) }}"
             hx-trigger="load, every 3s"
             hx-swap="innerHTML">
            
            <!-- 
              Messages will be loaded here by HTMX.
              We can include the partial here to show
              messages on the initial load instantly.
            -->
            {% include '_chat_messages.html' %}

        </div>

        <!-- 
          Message Form 
          hx-post: Sends the form via AJAX.
          hx-target: Puts the response (the new message list) into the #chat-window.
          hx-on::after-request: Clears the form text after sending.
        -->
        <form hx-post="{{ url_for('main.chat', username=recipient.username) }}"
              hx-target="#chat-window"
              hx-swap="innerHTML"
              hx-on::after-request="this.reset()"
              class="mt-4">
              
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.message(class="form-control", rows=3, placeholder="Write a message...") }}
                {% for error in form.message.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </div>
            {{ form.submit(class="btn btn-primary") }}
        </form>
    </div>
</div>
{% endblock %}