{% extends "base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h2 class="mb-4">Chat with {{ recipient.username }}</h2>

        <!-- 
          --- HTMX POLLING CONTAINER ---
          This div is now the main container.
          Notice the "{% include ... %}" line is GONE.
          'hx-trigger="load"' will now correctly load the messages
          into this empty div on page load.
        -->
        <div id="chat-window"
             class="chat-container" 
             style="height: 50vh; overflow-y: scroll; display: flex; flex-direction: column-reverse;"
             hx-get="{{ url_for('main.chat_messages', username=recipient.username) }}"
             hx-trigger="load, every 3s"
             hx-swap="innerHTML">
            
            <!-- This space is intentionally left empty! -->
            <!-- HTMX will fill it. -->

        </div>

        <!-- Message Form -->
        <form hx-post="{{ url_for('main.chat', username=recipient.username) }}"
              hx-target="#chat-window"
              hx-swap="innerHTML"
              hx-on::after-request="this.reset()"
              class="mt-4">
              
            {{ form.hidden_tag() }}
            <div class="mb-3">
                {{ form.message(class="form-control", rows=3, placeholder="Write a message...") }}
                {% for error in form.message.errors %}
                <span class="text-danger">[{{ error }}]</span>
                {% endfor %}
            </div>
            {{ form.submit(class="btn btn-primary") }}
        </form>
    </div>
</div>
{% endblock %}